services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    environment:
      - CADDY_INGRESS_NETWORKS=safee-network
    networks:
      - safee-network
    # depends_on commented out since frontend/backend run locally
    # depends_on:
    #   - frontend
    #   - backend

  postgres:
    image: postgres:15
    ports:
      - "15432:5432"
    environment:
      - POSTGRES_USER=safee
      - POSTGRES_PASSWORD=safee
      - POSTGRES_DB=safee
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U safee"]
      interval: 2s
      timeout: 5s
      retries: 5
    volumes:
      - "postgres:/var/lib/postgresql/data"
    networks:
      - safee-network

  redis:
    image: redis
    ports:
      - "16379:6379"
    volumes:
      - "redis:/data"
    networks:
      - safee-network

  odoo:
    build:
      context: .
      dockerfile: odoo/Dockerfile
    image: safee-odoo:18.0
    ports:
      - "8069:8069"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - HOST=postgres
      - PORT=5432
      - USER=safee
      - PASSWORD=safee
      - ODOO_ADMIN_PASSWORD=${ODOO_ADMIN_PASSWORD:-admin}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - SLACK_ERROR_CHANNEL=${SLACK_ERROR_CHANNEL:-#dev_odoo_alerts}
    volumes:
      - odoo-data:/var/lib/odoo
      - ./odoo/odoo.conf:/etc/odoo/odoo.conf:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - safee-network

  # Backend Gateway (Express/TSOA)
  # Uncomment to run backend in Docker
  # backend:
  #   build:
  #     context: .
  #     dockerfile: gateway/Dockerfile
  #   expose:
  #     - "3000"
  #   environment:
  #     - NODE_ENV=production
  #     - DATABASE_URL=postgresql://safee:safee@postgres:5432/safee
  #     - REDIS_URL=redis://redis:6379
  #   depends_on:
  #     - postgres
  #     - redis
  #   networks:
  #     - safee-network

  # Frontend (Next.js)
  # Uncomment to run frontend in Docker
  # frontend:
  #   build:
  #     context: .
  #     dockerfile: frontend/Dockerfile
  #   expose:
  #     - "3001"
  #   environment:
  #     - NODE_ENV=production
  #   networks:
  #     - safee-network

networks:
  safee-network:
    driver: bridge

volumes:
  postgres:
  redis:
  odoo-data:
  caddy-data:
  caddy-config:
  caddy-logs:
