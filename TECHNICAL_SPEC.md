# Safee Analytics - Technical Specification Document

## 1. Architecture Overview

### System Architecture
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   API Gateway   │    │   Backend       │
│   (React SPA)   │◄──►│   (NestJS)      │◄──►│   (NestJS)      │
│                 │    │                 │    │   Monolith      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                               ┌─────────────────┐
                                               │   PostgreSQL    │
                                               │   Database      │
                                               └─────────────────┘
```

### Design Principles
- **Separation of Concerns**: Clean layered architecture
- **Modularity**: Modular monolith ready for microservices extraction
- **Scalability**: Horizontal scaling capabilities
- **Security**: Zero-trust security model
- **Maintainability**: Clean code and comprehensive testing

## 2. Frontend Specifications

### Technology Stack
- **Framework**: React 18+ with TypeScript
- **State Management**: Zustand (primary) or Redux Toolkit
- **Styling**: Tailwind CSS
- **Routing**: React Router v6
- **Forms**: React Hook Form with Zod validation
- **HTTP Client**: Axios with interceptors
- **Build Tool**: Vite
- **Testing**: Jest + React Testing Library

### Architecture Pattern
- **Component Structure**: Atomic Design methodology
- **State Management**: Global state for user/auth, local state for components
- **Code Organization**: Feature-based folder structure

```
src/
├── components/           # Reusable UI components
│   ├── atoms/
│   ├── molecules/
│   └── organisms/
├── features/            # Feature-specific code
│   ├── auth/
│   ├── hisabiq/
│   ├── kanz/
│   └── nisbah/
├── hooks/               # Custom React hooks
├── services/            # API calls and external services
├── stores/              # Zustand stores
├── utils/               # Utility functions
└── types/               # TypeScript type definitions
```

### Key Features
- **Internationalization**: React-i18next with RTL support
- **Responsive Design**: Mobile-first approach
- **Progressive Web App**: Service worker for offline capabilities
- **Accessibility**: WCAG 2.1 AA compliance

## 3. API Gateway Specifications

### Technology Stack
- **Framework**: NestJS with TypeScript
- **Authentication**: JWT with RS256 signing
- **Rate Limiting**: Built-in rate limiting middleware
- **Caching**: Redis for response caching
- **Validation**: Class-validator and class-transformer
- **Documentation**: Swagger/OpenAPI 3.0

### Core Responsibilities
- **Authentication & Authorization**: JWT validation and RBAC
- **Request Routing**: Proxy requests to backend services
- **Rate Limiting**: Protect backend from abuse
- **Response Caching**: Cache frequently requested data
- **Request/Response Transformation**: API versioning and data formatting
- **Logging & Monitoring**: Centralized logging and metrics

### Security Features
- **JWT Validation**: All requests except auth endpoints
- **CORS Configuration**: Strict origin policies
- **Helmet**: Security headers
- **Input Sanitization**: XSS and injection protection
- **Rate Limiting**: Per-user and per-endpoint limits

## 4. Backend Specifications

### Technology Stack
- **Framework**: Express.js with TypeScript - Simple, fast, battle-tested
- **API Layer**: TSOA - Automatic OpenAPI generation, decorators without DI complexity
- **ORM**: Prisma with PostgreSQL (Azure Flexible Server)
- **Authentication**: JWT with refresh tokens
- **Caching**: Redis (Azure Cache for Redis)
- **Validation**: Zod - TypeScript-first schema validation
- **Testing**: Jest with Supertest for integration tests
- **Documentation**: Auto-generated Swagger/OpenAPI 3.0 via TSOA
- **Deployment**: Azure App Service (Linux)

### Simplified Modular Architecture (TSOA + Express)
```
src/
├── controllers/         # TSOA controllers (routes auto-generated)
│   ├── authController.ts
│   ├── invoiceController.ts
│   ├── employeeController.ts
│   └── crmController.ts
├── services/           # Business logic services
│   ├── invoiceService.ts
│   ├── payrollService.ts
│   └── crmService.ts
├── middleware/         # Express middleware
│   ├── auth.ts
│   ├── validation.ts
│   └── errorHandler.ts
├── models/            # TypeScript interfaces and types
├── utils/             # Shared utilities
├── database/          # Prisma schema and migrations
├── routes/            # Auto-generated by TSOA
└── server.ts          # Express app setup
```

### Database Design

#### Core Entities
- **User**: User accounts and profiles
- **Organization**: Multi-tenant organization management
- **Role**: Role-based access control
- **Permission**: Granular permissions

#### Hisabiq Entities
- **Invoice**: Invoice management
- **InvoiceItem**: Invoice line items
- **Customer**: Customer information
- **Payment**: Payment tracking

#### Kanz Entities
- **Employee**: Employee profiles
- **PayrollRun**: Payroll processing
- **Salary**: Salary structures
- **Attendance**: Time tracking

#### Nisbah Entities
- **Lead**: Lead management
- **Contact**: Customer contacts
- **Opportunity**: Sales opportunities
- **Activity**: Customer interactions

### API Design Standards
- **RESTful URLs**: Consistent resource naming
- **HTTP Status Codes**: Proper status code usage
- **Error Handling**: Standardized error responses
- **Pagination**: Cursor-based pagination for large datasets
- **Filtering & Sorting**: Query parameter standards
- **Versioning**: URL versioning (/api/v1/)

### Data Validation
- **Input Validation**: DTO classes with decorators
- **Business Logic Validation**: Service-level validation
- **Database Constraints**: Prisma schema constraints

## 5. Database Specifications

### Technology
- **Database**: PostgreSQL 15+
- **ORM**: Prisma
- **Migrations**: Prisma migrate
- **Connection Pooling**: PgBouncer or Prisma connection pooling

### Schema Design Principles
- **Normalization**: Third normal form (3NF)
- **Indexing**: Strategic indexing for query performance
- **Constraints**: Foreign keys and check constraints
- **Audit Trail**: Created/updated timestamps on all entities

### Performance Considerations
- **Indexes**: Composite indexes for common query patterns
- **Partitioning**: Table partitioning for large datasets
- **Archiving**: Data archiving strategy for historical data

## 6. Security Specifications

### Authentication & Authorization
- **JWT Tokens**: RS256 signed tokens with 15-minute expiry
- **Refresh Tokens**: 30-day expiry with rotation
- **Multi-Factor Authentication**: TOTP support
- **Session Management**: Stateless JWT-based sessions

### Data Protection
- **Encryption at Rest**: Database-level encryption
- **Encryption in Transit**: TLS 1.3 for all communications
- **Secrets Management**: Azure Key Vault integration
- **Data Masking**: PII masking in logs and non-production environments

### Access Control
- **Role-Based Access Control (RBAC)**: Hierarchical roles
- **Resource-Level Permissions**: Granular permissions
- **API Rate Limiting**: User and endpoint-based limits
- **IP Whitelisting**: Optional IP restriction

## 7. Performance Specifications

### Response Time Requirements
- **API Endpoints**: < 200ms for 95th percentile
- **Database Queries**: < 100ms for simple queries
- **Complex Reports**: < 5 seconds
- **File Uploads**: Support up to 10MB files

### Scalability Requirements
- **Concurrent Users**: Support 1000+ concurrent users
- **Database Connections**: Efficient connection pooling
- **Horizontal Scaling**: Stateless application design
- **Load Balancing**: Azure Load Balancer integration

### Caching Strategy
- **Application Cache**: Redis for session and API response caching
- **Database Cache**: Query result caching
- **CDN**: Static asset delivery via Azure CDN
- **Browser Cache**: Proper cache headers for static assets

## 8. Deployment & DevOps

### Infrastructure (Cost-Optimized Azure)
- **Cloud Provider**: Microsoft Azure (Qatar Central for compliance)
- **Compute**: Azure App Service (B1/S1/P1v3 based on environment)
- **Database**: PostgreSQL Flexible Server (Burstable for dev, GP for prod)
- **Cache**: Azure Cache for Redis (Standard tier)
- **Storage**: Azure Storage Account (LRS for dev, GRS for prod)
- **Networking**: Virtual Networks with private endpoints

### Environment Specifications
| Environment | App Service | PostgreSQL | Monthly Cost |
|-------------|------------|------------|--------------|
| Development | B1 (1GB RAM) | B1ms Burstable | ~$37 |
| Staging | S1 (1.75GB RAM) | Enhanced | ~$60 |
| Production | P1v3 (4GB RAM) | GP_Standard_D2s_v3 | ~$241 |

### CI/CD Pipeline
- **Version Control**: Git with GitFlow workflow
- **Build Pipeline**: GitHub Actions or Azure DevOps
- **Testing**: Automated unit and integration tests
- **Deployment**: Blue-green deployment strategy

### Monitoring & Logging
- **Application Monitoring**: Azure Monitor
- **Logging**: Structured logging with Azure Log Analytics
- **Error Tracking**: Application Insights
- **Health Checks**: Custom health check endpoints

### Backup & Recovery
- **Database Backup**: Automated daily backups with 30-day retention
- **Point-in-Time Recovery**: 7-day recovery window
- **Disaster Recovery**: Cross-region backup replication

## 9. Testing Strategy

### Testing Pyramid
- **Unit Tests**: 70% coverage target for business logic
- **Integration Tests**: API endpoint testing
- **End-to-End Tests**: Critical user journey testing
- **Performance Tests**: Load testing with artillery or k6

### Quality Assurance
- **Code Quality**: ESLint, Prettier, SonarQube
- **Security Testing**: OWASP ZAP integration
- **Accessibility Testing**: axe-core integration
- **Browser Testing**: Cross-browser compatibility

## 10. Maintenance & Support

### Documentation
- **API Documentation**: Auto-generated OpenAPI specs
- **Code Documentation**: TSDoc for complex functions
- **Deployment Documentation**: Infrastructure as Code
- **User Documentation**: End-user guides and tutorials

### Maintenance Schedule
- **Security Updates**: Monthly security patch cycles
- **Feature Updates**: Bi-weekly feature releases
- **Database Maintenance**: Weekly maintenance windows
- **Performance Reviews**: Monthly performance audits

---

**Document Version**: 1.0  
**Last Updated**: 2025-08-25  
**Next Review Date**: 2025-09-25  
**Technical Lead**: [To be assigned]